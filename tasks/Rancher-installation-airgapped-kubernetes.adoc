// source: https://github.com/rancher/rancher-product-docs/edit/main/versions/v2.13/modules/en/pages/installation-and-upgrade/other-installation-methods/air-gapped/install-kubernetes.adoc
// base URL: https://documentation.suse.com/cloudnative/rancher-manager/latest/en/
// product name: {ranchermanager}
[#rancher-installation-airgapped-kubernetes]
include::../common/generic-attributes.adoc[]
// overridden title?
ifdef::override-title[]
= {override-title}
:revdate: 2026-01-28
:page-revdate: {revdate}
endif::[]
ifndef::override-title[]
= Installing {ranchermanager} in air-gapped environments: install {kube}
endif::[]
// overridden abstract?
ifdef::override-abstract[]
{override-abstract}
endif::[]
ifndef::override-abstract[]
This section describes how to install a {k8s} cluster according to our best practices for the {ranchermanager} server environment.
This cluster should be dedicated to running only the {ranchermanager} server.
endif::[]

// erase the flag for future overrides
:override-abstract!:
:override-title!:

[NOTE]
====
Skip this section if you are installing {ranchermanager} on a single node with {docker}.
====

Rancher can be installed on any Kubernetes cluster, including hosted Kubernetes providers.

The steps to set up an air-gapped Kubernetes cluster on RKE, RKE2, or K3s are shown below.

--
In this guide, we are assuming you have created your nodes in your air-gapped environment and have a secure Docker private registry on your bastion server.

[#_1_create_rke2_configuration]]
== 1. Create RKE2 configuration

Create the `config.yaml` file at `/etc/rancher/rke2/config.yaml`. This will contain all the configuration options necessary to create a highly available RKE2 cluster.

On the first server the minimum configuration is:

----
token: my-shared-secret
tls-san:
  - loadbalancer-dns-domain.com
----

On each other server the configuration file should contain the same token and tell RKE2 to connect to the existing first server:

----
server: https://ip-of-first-server:9345
token: my-shared-secret
tls-san:
  - loadbalancer-dns-domain.com
----

For more information, refer to the https://documentation.suse.com/cloudnative/rke2/latest/en/install/ha.html[RKE2 documentation].

[NOTE]
====

RKE2 additionally provides a `resolv-conf` option for kubelets, which may help with configuring DNS in air-gap networks.
====

[[_2_create_registry_yaml]]
== 2. Create Registry YAML

Create the `registries.yaml` file at `/etc/rancher/rke2/registries.yaml`. This will tell RKE2 the necessary details to connect to your private registry.

The `registries.yaml` file should look like this before plugging in the necessary information:

----
---
mirrors:
  customreg:
    endpoint:
      - "https://ip-to-server:5000"
configs:
  customreg:
    auth:
      username: xxxxxx # this is the registry username
      password: xxxxxx # this is the registry password
    tls:
      cert_file: <path to the cert file used in the registry>
      key_file:  <path to the key file used in the registry>
      ca_file: <path to the ca file used in the registry>
----

For more information on private registries configuration file for RKE2, refer to the https://documentation.suse.com/cloudnative/rke2/latest/en/install/containerd_registry_configuration.html[RKE2 documentation.]


[[_3_install_rke2]]
== 3. Install RKE2

Rancher needs to be installed on a supported Kubernetes version. To find out which versions of Kubernetes are supported for your Rancher version, refer to the link:https://www.suse.com/suse-rancher/support-matrix/all-supported-versions/[SUSE Rancher Support Matrix].

Download the install script, rke2, rke2-images, and sha256sum archives from the release and upload them into a directory on each server:

----
mkdir /tmp/rke2-artifacts && cd /tmp/rke2-artifacts/
wget https://github.com/rancher/rke2/releases/download/v1.21.5%2Brke2r2/rke2-images.linux-amd64.tar.zst
wget https://github.com/rancher/rke2/releases/download/v1.21.5%2Brke2r2/rke2.linux-amd64.tar.gz
wget https://github.com/rancher/rke2/releases/download/v1.21.5%2Brke2r2/sha256sum-amd64.txt
curl -sfL https://get.rke2.io --output install.sh
----

Next, run install.sh using the directory on each server, as in the example below:

----
INSTALL_RKE2_ARTIFACT_PATH=/tmp/rke2-artifacts sh install.sh
----

Then enable and start the service on all servers:

`
systemctl enable rke2-server.service
systemctl start rke2-server.service
`

For more information, refer to the https://documentation.suse.com/cloudnative/rke2/latest/en/install/airgap.html[RKE2 documentation].

[[_4_save_and_start_using_the_kubeconfig_file]]
== 4. Save and Start Using the kubeconfig File

When you installed RKE2 on each Rancher server node, a `kubeconfig` file was created on the node at `/etc/rancher/rke2/rke2.yaml`. This file contains credentials for full access to the cluster, and you should save this file in a secure location.

To use this `kubeconfig` file,

. Install https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl[kubectl], a Kubernetes command-line tool.
. Copy the file at `/etc/rancher/rke2/rke2.yaml` and save it to the directory `~/.kube/config` on your local machine.
. In the kubeconfig file, the `server` directive is defined as localhost. Configure the server as the DNS of your load balancer, referring to port 6443. (The Kubernetes API server will be reached at port 6443, while the Rancher server will be reached at ports 80 and 443.) Here is an example `rke2.yaml`:

----
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: [CERTIFICATE-DATA]
    server: [LOAD-BALANCER-DNS]:6443 # Edit this line
  name: default
contexts:
- context:
    cluster: default
    user: default
  name: default
current-context: default
kind: Config
preferences: {}
users:
- name: default
  user:
    password: [PASSWORD]
    username: admin
----

*Result:* You can now use `kubectl` to manage your RKE2 cluster. If you have more than one kubeconfig file, you can specify which one you want to use by passing in the path to the file when using `kubectl`:

----
kubectl --kubeconfig ~/.kube/config/rke2.yaml get pods --all-namespaces
----

For more information about the `kubeconfig` file, refer to the https://documentation.suse.com/cloudnative/rke2/latest/en/cluster_access.html[RKE2 documentation] or the https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/[official Kubernetes documentation] about organizing cluster access using `kubeconfig` files.

[#_note_on_upgrading]
== Note on Upgrading

Upgrading an air-gap environment can be accomplished in the following manner:

. Download the new air-gap artifacts and install script from the https://github.com/rancher/rke2/releases[releases] page for the version of RKE2 you will be upgrading to.
. Run the script again just as you had done in the past with the same environment variables.
. Restart the RKE2 service.
--
